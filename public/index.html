<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Intention BDD — Gherkin Generator</title>
    <style>
      :root { --bg:#0b1020; --fg:#e6e6e6; --muted:#94a3b8; --accent:#7c3aed; --panel:#111827; --ok:#10b981; --warn:#f59e0b; --err:#ef4444; }
      * { box-sizing: border-box; }
      body { margin:0; background:var(--bg); color:var(--fg); font-family: Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica, Arial, sans-serif; }
      header { padding:20px 24px; border-bottom:1px solid #1f2937; display:flex; align-items:center; justify-content:space-between; }
      header h1 { margin:0; font-size:18px; font-weight:600; }
      header .sub { color:var(--muted); font-size:13px; }
      main { max-width:1100px; margin:24px auto; padding:0 16px; display:grid; grid-template-columns: 1fr 1fr; gap:16px; }
      .full { grid-column: 1 / -1; }
      .card { background:var(--panel); border:1px solid #1f2937; border-radius:12px; padding:16px; }
      .card h2 { margin:0 0 12px 0; font-size:16px; font-weight:600; }
      label { display:block; font-size:13px; color:var(--muted); margin-bottom:6px; }
      input[type=text] { width:100%; padding:10px 12px; background:#0f172a; color:var(--fg); border:1px solid #1f2937; border-radius:8px; }
      .row { display:flex; gap:12px; align-items:flex-end; }
      button { background:var(--accent); color:white; border:none; border-radius:8px; padding:10px 14px; cursor:pointer; font-weight:600; }
      button[disabled] { opacity:.6; cursor:default; }
      .badge { display:inline-flex; align-items:center; gap:6px; border-radius:999px; padding:4px 8px; font-size:12px; }
      .badge.ok { background:rgba(16,185,129,.15); color:#10b981; }
      .badge.run { background:rgba(124,58,237,.15); color:#a78bfa; }
      .badge.err { background:rgba(239,68,68,.15); color:#ef4444; }
      pre { margin:0; white-space:pre-wrap; }
      .log { background:#0a0f1f; color:#9ae6b4; border-radius:8px; padding:12px; max-height:260px; overflow:auto; font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace; font-size:12px; }
      .code { background:#0f172a; color:#e5e7eb; border-radius:8px; padding:12px; min-height:240px; font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace; font-size:13px; }
      .actions { display:flex; gap:8px; }
      .muted { color:var(--muted); font-size:12px; }
      .split { display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
      .hint { color:#cbd5e1; font-size:12px; margin-top:8px; }
      .examples a { color:#93c5fd; text-decoration:none; }
      .examples a:hover { text-decoration:underline; }
    </style>
  </head>
  <body>
    <header>
      <div>
        <h1>Intention BDD</h1>
        <div class="sub">Generate unit‑leaning Gherkin from public GitHub repos</div>
      </div>
      <div id="status" class="badge">Idle</div>
    </header>
    <main>
      <section class="card full">
        <h2>Repository</h2>
        <form id="gen-form">
          <div class="row">
            <div style="flex:1">
              <label for="repo">GitHub repo or URL</label>
              <input id="repo" type="text" placeholder="owner/repo or https://github.com/owner/repo" required />
            </div>
            <div style="width:180px">
              <label for="branch">Branch (optional)</label>
              <input id="branch" type="text" placeholder="main" />
            </div>
            <div>
              <button id="submitBtn" type="submit">Generate</button>
            </div>
          </div>
          <div class="hint examples">Examples: 
            <a href="#" data-example="vercel/next.js">vercel/next.js</a> · 
            <a href="#" data-example="facebook/react">facebook/react</a> · 
            <a href="#" data-example="nestjs/nest">nestjs/nest</a>
          </div>
        </form>
      </section>

      <section class="card">
        <h2>Progress</h2>
        <pre id="progress" class="log"></pre>
        <div class="muted" id="timing"></div>
      </section>

      <section class="card">
        <h2>Planning (visibility)</h2>
        <pre id="plan" class="code" placeholder="# Plan will appear here"></pre>
      </section>

      <section class="card full">
        <div style="display:flex;align-items:center;justify-content:space-between;gap:8px;">
          <h2 style="margin:0">Generated Gherkin</h2>
          <div class="actions">
            <button id="copyBtn" disabled>Copy</button>
            <button id="downloadBtn" disabled>Download .feature</button>
            <span class="muted" id="len"></span>
          </div>
        </div>
        <pre id="gherkin" class="code"></pre>
      </section>
    </main>
    <script>
      const $ = (id) => document.getElementById(id);
      const statusEl = $('status');
      const form = $('gen-form');
      const progressEl = $('progress');
      const planEl = $('plan');
      const gherkinEl = $('gherkin');
      const submitBtn = $('submitBtn');
      const copyBtn = $('copyBtn');
      const downloadBtn = $('downloadBtn');
      const lenEl = $('len');
      const timingEl = $('timing');
      let es = null; let startedAt = 0;

      function setStatus(kind, text){
        const cls = kind==='ok'?'badge ok': kind==='err'?'badge err':'badge run';
        statusEl.className = cls; statusEl.textContent = text;
      }
      function append(line){
        const ts = new Date().toISOString();
        progressEl.textContent += `[${ts}] ${line}\n`;
        progressEl.scrollTop = progressEl.scrollHeight;
      }
      function setGherkin(text){
        gherkinEl.textContent = text || '';
        const n = (text||'').length;
        lenEl.textContent = n ? `${n} chars` : '';
        copyBtn.disabled = !n; downloadBtn.disabled = !n;
      }
      function setPlan(text){
        planEl.textContent = text || '';
      }
      function reset(){
        progressEl.textContent=''; setGherkin(''); setPlan(''); lenEl.textContent='';
        timingEl.textContent=''; startedAt=0; setStatus('run','Idle');
      }
      function elapsed(){
        if(!startedAt) return ''; const ms = Date.now()-startedAt;
        const s = Math.floor(ms/1000); return `${s}s elapsed`;
      }

      document.querySelectorAll('[data-example]').forEach(a=>{
        a.addEventListener('click',(e)=>{ e.preventDefault(); $('repo').value = a.dataset.example; });
      });

      copyBtn.addEventListener('click', async ()=>{
        const text = gherkinEl.textContent; if(!text) return;
        try{ await navigator.clipboard.writeText(text); append('Gherkin copied to clipboard'); }catch{ append('Copy failed'); }
      });
      downloadBtn.addEventListener('click', ()=>{
        const text = gherkinEl.textContent; if(!text) return;
        const blob = new Blob([text], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = 'generated.feature'; a.click();
        setTimeout(()=>URL.revokeObjectURL(url), 1000);
      });

      form.addEventListener('submit', async (e) => {
        e.preventDefault(); if(es){ es.close(); es=null; }
        const repo = $('repo').value.trim();
        const branch = $('branch').value.trim();
        reset(); setStatus('run','Running'); submitBtn.disabled=true; startedAt=Date.now();
        try {
          const resp = await fetch('/api/generate', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ repo, branch: branch || undefined })});
          if(!resp.ok){ append('Failed to start job: ' + (await resp.text())); submitBtn.disabled=false; setStatus('err','Error'); return; }
          const { jobId } = await resp.json();
          append('Job started: ' + jobId);
          es = new EventSource('/api/progress/' + jobId);
          es.addEventListener('status', (ev) => {
            const { status } = JSON.parse(ev.data);
            append('Status: ' + status);
            if(status==='done'){ setStatus('ok','Done'); submitBtn.disabled=false; timingEl.textContent = elapsed(); }
            if(status==='error'){ setStatus('err','Error'); submitBtn.disabled=false; timingEl.textContent = elapsed(); }
          });
          es.addEventListener('log', (ev) => {
            const { message } = JSON.parse(ev.data);
            if (typeof message === 'string' && message.startsWith('::plan::')) {
              const plan = message.slice('::plan::'.length).trimStart();
              setPlan(plan);
            } else {
              append(message);
            }
          });
          es.addEventListener('done', (ev) => {
            const { gherkin } = JSON.parse(ev.data);
            if (gherkin) setGherkin(gherkin);
          });
          es.onerror = () => { /* keep alive or let it close */ };
        } catch(err) {
          append('Error: ' + (err?.message || String(err)));
          submitBtn.disabled=false; setStatus('err','Error');
        }
      });
    </script>
  </body>
  </html>
